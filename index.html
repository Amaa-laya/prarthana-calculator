<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NSB Savings Calculator</title>
<style>
  :root {
    --nsb: #f58220;
    --grey: #e0e0e0;
  }
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f5f5f5;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding-top: 50px;
  }
  .container {
    background: #fff;
    padding: 28px 26px;
    border-radius: 16px;
    box-shadow: 0 4px 18px rgba(0,0,0,.1);
    max-width: 960px;
    width: 100%;
    box-sizing: border-box;
  }
  h2 {
    margin: 0 0 22px;
    text-align: center;
    color: var(--nsb);
  }
  /* Sidebar */
  .hamburger {
    position: fixed;
    top: 18px;
    left: 18px;
    background: #fff;
    color: var(--nsb);
    font-size: 28px;
    padding: 6px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    cursor: pointer;
    z-index: 1100;
    user-select: none;
  }
  .sidebar {
    position: fixed;
    left: -260px;
    top: 0;
    width: 260px;
    height: 100%;
    background: var(--nsb);
    padding-top: 60px;
    transition: left 0.3s ease;
    z-index: 1000;
    box-sizing: border-box;
  }
  .sidebar.open {
    left: 0;
  }
  .sidebar a {
    display: block;
    padding: 16px 24px;
    color: #fff;
    text-decoration: none;
    font-weight: bold;
    font-size: 18px;
  }
  .sidebar a:hover,
  .sidebar a:focus {
    background: #e06d0f;
    outline: none;
  }
  /* Language selector */
  .lang {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
  }
  .lang select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  /* Tabs */
  .tabs {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 18px;
  }
  .tab {
    background: var(--grey);
    padding: 10px 24px;
    margin: 4px;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    transition: 0.3s;
  }
  .tab.active {
    background: var(--nsb);
    color: #fff;
  }
  .tab:focus {
    outline: 2px solid var(--nsb);
    outline-offset: 2px;
  }
  /* Tab content */
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  /* Form */
  form {
    border: 2px solid var(--nsb);
    padding: 20px;
    border-radius: 12px;
  }
  .form-grid {
    display: grid;
    grid-template-columns: minmax(120px, 1fr) 2fr;
    gap: 12px 20px;
    align-items: center;
  }
  .form-grid-full {
    grid-column: 1/-1;
  }
  @media(max-width: 540px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
  label {
    font-weight: 600;
  }
  input, select {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--nsb);
    border-radius: 8px;
    font-size: 15px;
    box-sizing: border-box;
    max-width: 100%;
  }
  .btns {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  button {
    background: var(--nsb);
    color: #fff;
    border: none;
    border-radius: 5px;
    padding: 9px 14px;
    font-size: 15px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  button:hover,
  button:focus {
    background: #e06d0f;
    outline: none;
  }
  .result {
    margin-top: 18px;
    min-height: 80px;
    font-size: 17px;
    font-weight: bold;
    color: #1976d2;
    white-space: pre-wrap;
  }
  /* Speech toggle */
  #speechToggle {
    position: fixed;
    bottom: 18px;
    right: 18px;
    background: var(--nsb);
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    user-select: none;
  }
  #speechToggle.active {
    background: #e06d0f;
  }
  #dateWarning {
    text-align: center;
    color: red;
    margin-bottom: 10px;
    font-weight: bold;
  }
</style>
</head>
<body>

<!-- Sidebar hamburger -->
<span class="hamburger" tabindex="0" role="button" aria-label="Toggle menu" onclick="toggleSidebar()" onkeypress="if(event.key==='Enter') toggleSidebar()">‚ò∞</span>

<!-- Sidebar menu -->
<nav id="sidebar" class="sidebar" aria-label="Product navigation">
  <a href="#" tabindex="0" role="button" aria-pressed="false" onclick="setProduct('prarthana');closeSidebar()" onkeypress="if(event.key==='Enter'){setProduct('prarthana');closeSidebar();}">Prarthana</a>
  <a href="#" tabindex="0" role="button" aria-pressed="false" onclick="setProduct('reality');closeSidebar()" onkeypress="if(event.key==='Enter'){setProduct('reality');closeSidebar();}">Reality</a>
</nav>

<!-- Main container -->
<div class="container" role="main">
  <!-- Date input support warning -->
  <div id="dateWarning" aria-live="polite" style="display:none;">
    Your browser may not support the date input fully. Please ensure you enter dates in the format YYYY-MM-DD.
  </div>

  <!-- Language selector -->
  <div class="lang">
    <label for="lang" class="sr-only">Select Language</label>
    <select id="lang" aria-label="Select language" onchange="applyLang()">
      <option value="en">English</option>
      <option value="si">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</option>
      <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
    </select>
  </div>

  <!-- Title -->
  <h2 id="title">NSB Prarthana Savings Calculator</h2>

  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="Calculator Tabs">
    <div id="tabReqBtn" class="tab active" role="tab" aria-selected="true" tabindex="0" aria-controls="req" onclick="showTab('req')" onkeypress="if(event.key==='Enter') showTab('req')">ü™ô <span id="txtReq">Required Deposit</span></div>
    <div id="tabMatBtn" class="tab" role="tab" aria-selected="false" tabindex="0" aria-controls="mat" onclick="showTab('mat')" onkeypress="if(event.key==='Enter') showTab('mat')">üí∞ <span id="txtMat">Maturity Value</span></div>
  </div>

  <!-- Required Deposit Tab -->
  <div id="req" class="tab-content active" role="tabpanel" aria-labelledby="tabReqBtn">
    <form id="formReq" onsubmit="event.preventDefault(); calcReq()" novalidate>
      <div class="form-grid">
        <label id="lblOpen" for="open">Opening Date:</label>
        <input id="open" type="date" required aria-required="true" onchange="updateMaturityDate()" aria-describedby="dateWarning">
        
        <label id="lblPer" for="per">Period:</label>
        <select id="per" required aria-required="true" onchange="updateMaturityDate()"></select>
        
        <label id="lblMdate" for="mdate">Maturity Date:</label>
        <input id="mdate" type="date" disabled aria-disabled="true" tabindex="-1">
        
        <label id="lblTarget" for="target">Target Amount (LKR):</label>
        <input id="target" type="number" min="0" step="0.01" required aria-required="true" aria-label="Target Amount in LKR">
        
        <label id="lblRate" for="rate">Interest Rate (%/yr):</label>
        <input id="rate" type="number" min="0" max="100" step="0.01" required aria-required="true" aria-label="Interest rate per year in percent">
      </div>
      <div class="btns form-grid-full">
        <button type="submit" aria-label="Calculate Required Deposit" id="calcReqBtn">üßÆ <span id="bCalc1">Calculate</span></button>
        <button type="button" aria-label="Clear Required Deposit Form" onclick="resetAll()">üßπ <span id="bClr1">Clear</span></button>
        <button type="button" aria-label="Print Required Deposit Result" onclick="printRes('res1')">üñ®Ô∏è <span id="bPrt1">Print</span></button>
        <button type="button" aria-label="Email Required Deposit Result" onclick="mailRes('res1')">üìß <span id="bMail1">Email</span></button>
      </div>
    </form>
    <div id="res1" class="result" aria-live="polite"></div>
  </div>

  <!-- Maturity Value Tab -->
  <div id="mat" class="tab-content" role="tabpanel" aria-labelledby="tabMatBtn">
    <form id="formMat" onsubmit="event.preventDefault(); calcMat()" novalidate>
      <div class="form-grid">
        <label id="lblOpen2" for="open2">Opening Date:</label>
        <input id="open2" type="date" required aria-required="true" onchange="updateMaturityDateMat()" aria-describedby="dateWarning">
        
        <label id="lblPer2" for="per2">Period:</label>
        <select id="per2" required aria-required="true" onchange="updateMaturityDateMat()"></select>
        
        <label id="lblMdate2" for="mdate2">Maturity Date:</label>
        <input id="mdate2" type="date" disabled aria-disabled="true" tabindex="-1">
        
        <label id="lblAmt" for="amt">Monthly Installment (LKR):</label>
        <input id="amt" type="number" min="0" step="0.01" required aria-required="true" aria-label="Monthly Installment in LKR">
        
        <label id="lblRate2" for="rate2">Interest Rate (%/mo):</label>
        <input id="rate2" type="number" min="0" max="100" step="0.01" required aria-required="true" aria-label="Interest rate per month in percent">
      </div>
      <div class="btns form-grid-full">
        <button type="submit" aria-label="Calculate Maturity Value" id="calcMatBtn">üßÆ <span id="bCalc2">Calculate</span></button>
        <button type="button" aria-label="Clear Maturity Value Form" onclick="resetAll()">üßπ <span id="bClr2">Clear</span></button>
        <button type="button" aria-label="Print Maturity Value Result" onclick="printRes('res2')">üñ®Ô∏è <span id="bPrt2">Print</span></button>
        <button type="button" aria-label="Email Maturity Value Result" onclick="mailRes('res2')">üìß <span id="bMail2">Email</span></button>
      </div>
    </form>
    <div id="res2" class="result" aria-live="polite"></div>
  </div>
</div>

<!-- Speech toggle button -->
<button id="speechToggle" aria-pressed="true" aria-label="Toggle speech on" title="Toggle speech">üîä</button>

<script>
// Utility function shortcut
const $ = id => document.getElementById(id);

// Product and language globals
let prod = 'prarthana'; // 'prarthana' or 'reality'
let speechEnabled = true;

// Period options
const Y = [3, 5, 10, 15, 20];  // years for Prarthana
const M = [12, 24, 36, 48, 60]; // months for Reality

// Language dictionary (all labels & buttons)
const TXT = {
  en: {
    titlePr: 'NSB Prarthana Savings Calculator',
    titleRe: 'NSB Reality Savings Calculator',
    req: 'Required Deposit',
    mat: 'Maturity Value',
    target: 'Target Amount (LKR):',
    deposit: 'Deposit Amount (LKR):',
    install: 'Monthly Installment (LKR):',
    calc: 'Calculate',
    clear: 'Clear',
    print: 'Print',
    email: 'Email',
    open: 'Opening Date:',
    per: 'Period:',
    matDate: 'Maturity Date:',
    rateYr: 'Interest Rate (%/yr):',
    rateMo: 'Interest Rate (%/mo):',
    speechOn: 'Speech On',
    speechOff: 'Speech Off',
    dateWarning: 'Your browser may not fully support date inputs. Please enter dates in YYYY-MM-DD format.'
  },
  si: {
    titlePr: 'NSB ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ª‡∑ä‡∂Æ‡∂±‡∑è ‡∂â‡∂≠‡∑í‡∂ª‡∑í‡∂ö‡∂ª‡∂´ ‡∂ú‡∂´‡∂ö‡∂∫',
    titleRe: 'NSB ‡∂ª‡∑í‡∂∫‡∑ê‡∂Ω‡∑í‡∂ß‡∑í ‡∂â‡∂≠‡∑í‡∂ª‡∑í‡∂ö‡∂ª‡∂´ ‡∂ú‡∂´‡∂ö‡∂∫',
    req: '‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑î',
    mat: '‡∂¥‡∑í‡∂ª‡∑í‡∂±‡∑ê‡∂∏‡∑ì‡∂∏‡∑ä ‡∑Ä‡∂ß‡∑í‡∂±‡∑è‡∂ö‡∂∏',
    target: '‡∂Ö‡∂ª‡∂∏‡∑î‡∂´‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.):',
    deposit: '‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.):',
    install: '‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑î (‡∂ª‡∑î.):',
    calc: '‡∂ú‡∂´‡∂±‡∂∫',
    clear: '‡∂ö‡∑Ö‡∂Ω',
    print: '‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∂´‡∂∫',
    email: '‡∂ä-‡∂≠‡∑ê‡∂¥‡∑ë‡∂Ω',
    open: '‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∂ö‡∂ª‡∂± ‡∂Ø‡∑í‡∂±‡∂∫:',
    per: '‡∂ö‡∑è‡∂Ω‡∂∫:',
    matDate: '‡∂¥‡∑í‡∂ª‡∑í‡∂±‡∑ê‡∂∏‡∑ì‡∂∏‡∑ä ‡∂Ø‡∑í‡∂±‡∂∫:',
    rateYr: '‡∂¥‡∑ú‡∂Ω‡∑ì ‡∂Ö‡∂±‡∑î‡∂¥‡∑è‡∂≠‡∂∫ (% ‡∑Ä‡∑É‡∂ª):',
    rateMo: '‡∂¥‡∑ú‡∂Ω‡∑ì ‡∂Ö‡∂±‡∑î‡∂¥‡∑è‡∂≠‡∂∫ (% ‡∂∏‡∑è‡∑É‡∑í‡∂ö):',
    speechOn: '‡∂ö‡∂Æ‡∂±‡∂∫ ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∂∫‡∑í',
    speechOff: '‡∂ö‡∂Æ‡∂±‡∂∫ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∂á‡∂≠',
    dateWarning: '‡∂î‡∂∂‡∑ö ‡∂∂‡∑ä‚Äç‡∂ª‡∑Ä‡∑î‡∑É‡∂ª‡∂∫ ‡∂Ø‡∑í‡∂±‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∑É‡∑Ñ‡∑è‡∂∫ ‡∂±‡∑ú‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂∫‡∑í. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑í‡∂±‡∂∫‡∂±‡∑ä YYYY-MM-DD ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫‡∑ô‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.'
  },
  ta: {
    titlePr: 'NSB ‡Æ™‡Æ∞‡Ææ‡Æ§‡Øç‡Æ§‡Æ©‡Ææ ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ©‡Øç',
    titleRe: 'NSB ‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ≤‡Æø‡Æü‡Øç‡Æü‡Æø ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ©‡Øç',
    req: '‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ',
    mat: '‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ',
    target: '‡Æá‡Æ≤‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡Øä‡Æï‡Øà (‡Æ∞‡ØÇ.)',
    deposit: '‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Øä‡Æï‡Øà (‡Æ∞‡ØÇ.)',
    install: '‡ÆÆ‡Ææ‡Æ§‡Ææ‡Æ®‡Øç‡Æ§‡Æø‡Æ∞ ‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ (‡Æ∞‡ØÇ.)',
    calc: '‡Æï‡Æ£‡Æï‡Øç‡Æï‡Æø‡Æü‡ØÅ',
    clear: '‡ÆÖ‡Æ¥‡Æø',
    print: '‡ÆÖ‡Æö‡Øç‡Æö‡ØÅ',
    email: '‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç',
    open: '‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øá‡Æ§‡Æø:',
    per: '‡Æï‡Ææ‡Æ≤‡ÆÆ‡Øç:',
    matDate: '‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø:',
    rateYr: '‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æµ‡Æø‡Æï‡Æø‡Æ§‡ÆÆ‡Øç (%/‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ):',
    rateMo: '‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æµ‡Æø‡Æï‡Æø‡Æ§‡ÆÆ‡Øç (%/‡ÆÆ‡Ææ‡Æ§‡ÆÆ‡Øç):',
    speechOn: '‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Øç ‡Æá‡ÆØ‡Æ≤‡ØÅ‡ÆÆ‡Øà',
    speechOff: '‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æï‡Øç‡Æï‡ÆÆ‡Øç',
    dateWarning: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø ‡Æ§‡Øá‡Æ§‡Æø‡Æ§‡Øç ‡Æ§‡ØÅ‡Æ±‡Øà‡ÆØ‡Øà ‡ÆÆ‡ØÅ‡Æ¥‡ØÅ‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æï ‡ÆÜ‡Æ§‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Ææ‡ÆÆ‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç. ‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øà YYYY-MM-DD ‡Æµ‡Æü‡Æø‡Æµ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç.'
  }
};

// Helper: get current language from dropdown
function curLang() {
  return $('lang').value || 'en';
}

// Save/load to localStorage for persistence
function saveState() {
  const state = {
    prod,
    lang: curLang(),
    speechEnabled,
    formReq: {
      open: $('open').value,
      per: $('per').value,
      target: $('target').value,
      rate: $('rate').value
    },
    formMat: {
      open2: $('open2').value,
      per2: $('per2').value,
      amt: $('amt').value,
      rate2: $('rate2').value
    },
    activeTab: $('tabReqBtn').classList.contains('active') ? 'req' : 'mat'
  };
  localStorage.setItem('nsbCalcState', JSON.stringify(state));
}

function loadState() {
  const stateStr = localStorage.getItem('nsbCalcState');
  if (!stateStr) return;
  try {
    const state = JSON.parse(stateStr);
    if (state.prod) setProduct(state.prod, false);
    if (state.lang) $('lang').value = state.lang;
    applyLang();
    if (state.formReq) {
      $('open').value = state.formReq.open || '';
      $('per').value = state.formReq.per || '';
      $('target').value = state.formReq.target || '';
      $('rate').value = state.formReq.rate || '';
    }
    if (state.formMat) {
      $('open2').value = state.formMat.open2 || '';
      $('per2').value = state.formMat.per2 || '';
      $('amt').value = state.formMat.amt || '';
      $('rate2').value = state.formMat.rate2 || '';
    }
    if (state.activeTab === 'mat') {
      showTab('mat', false);
    } else {
      showTab('req', false);
    }
    if (typeof state.speechEnabled === 'boolean') {
      speechEnabled = state.speechEnabled;
      updateSpeechToggle();
    }
    updateMaturityDate();
    updateMaturityDateMat();
  } catch (e) {
    console.warn('Failed to load saved state:', e);
  }
}

// Sidebar toggle
function toggleSidebar() {
  const sidebar = $('sidebar');
  sidebar.classList.toggle('open');
}

function closeSidebar() {
  const sidebar = $('sidebar');
  sidebar.classList.remove('open');
}

// Set product, update UI & period options
function setProduct(p, save = true) {
  prod = p;
  closeSidebar();
  const title = prod === 'prarthana' ? TXT[curLang()].titlePr : TXT[curLang()].titleRe;
  $('title').textContent = title;

  // Update period options depending on product
  fillPeriods();

  // Reset results and inputs (but keep previous if loading)
  // clearResults();
  // resetAll(); // Removed auto clear so user data isn't lost on product change

  if (save) saveState();
}

// Fill period selects with correct options
function fillPeriods() {
  const perSelect = $('per');
  const per2Select = $('per2');

  // Clear current options
  perSelect.innerHTML = '';
  per2Select.innerHTML = '';

  const periods = prod === 'prarthana' ? Y : M;
  const perText = prod === 'prarthana' ? (curLang() === 'en' ? 'Year' : (curLang() === 'si' ? '‡∑Ä‡∑É‡∂ª' : '‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ')) :
    (curLang() === 'en' ? 'Month' : (curLang() === 'si' ? '‡∂∏‡∑è‡∑É' : '‡ÆÆ‡Ææ‡Æ§‡ÆÆ‡Øç'));

  periods.forEach(p => {
    const opt1 = document.createElement('option');
    opt1.value = p;
    opt1.textContent = p + ' ' + (p > 1 ? perText + 's' : perText);
    perSelect.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = p;
    opt2.textContent = p + ' ' + (p > 1 ? perText + 's' : perText);
    per2Select.appendChild(opt2);
  });

  // If values previously set, keep or reset to first option
  if (!periods.includes(+perSelect.value)) perSelect.value = periods[0];
  if (!periods.includes(+per2Select.value)) per2Select.value = periods[0];
}

// Language apply: update all labels and button text
function applyLang() {
  const l = curLang();
  const t = TXT[l];

  // Titles
  $('title').textContent = prod === 'prarthana' ? t.titlePr : t.titleRe;
  $('tabReqBtn').querySelector('span').textContent = t.req;
  $('tabMatBtn').querySelector('span').textContent = t.mat;

  // Labels Req
  $('lblOpen').textContent = t.open;
  $('lblPer').textContent = t.per;
  $('lblMdate').textContent = t.matDate;
  $('lblTarget').textContent = t.target;
  $('lblRate').textContent = prod === 'prarthana' ? t.rateYr : t.rateMo;

  // Labels Mat
  $('lblOpen2').textContent = t.open;
  $('lblPer2').textContent = t.per;
  $('lblMdate2').textContent = t.matDate;
  $('lblAmt').textContent = prod === 'prarthana' ? t.deposit : t.install;
  $('lblRate2').textContent = prod === 'prarthana' ? t.rateYr : t.rateMo;

  // Buttons
  $('bCalc1').textContent = t.calc;
  $('bClr1').textContent = t.clear;
  $('bPrt1').textContent = t.print;
  $('bMail1').textContent = t.email;

  $('bCalc2').textContent = t.calc;
  $('bClr2').textContent = t.clear;
  $('bPrt2').textContent = t.print;
  $('bMail2').textContent = t.email;

  // Date input warning text
  $('dateWarning').textContent = t.dateWarning;

  // Fill periods with updated language
  fillPeriods();

  // Save state
  saveState();
}

// Show tab content, manage ARIA
function showTab(id, save = true) {
  const tabs = ['req', 'mat'];
  tabs.forEach(t => {
    const btn = $(t === 'req' ? 'tabReqBtn' : 'tabMatBtn');
    const content = $(t);
    if (t === id) {
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      btn.tabIndex = 0;
      content.classList.add('active');
    } else {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
      btn.tabIndex = -1;
      content.classList.remove('active');
    }
  });
  if (save) saveState();
}

// Update maturity date in Req form based on open date and period
function updateMaturityDate() {
  const openDate = new Date($('open').value);
  const period = Number($('per').value);
  if (isNaN(openDate.getTime()) || !period) {
    $('mdate').value = '';
    return;
  }

  if (prod === 'prarthana') {
    // Add years
    openDate.setFullYear(openDate.getFullYear() + period);
  } else {
    // Add months
    openDate.setMonth(openDate.getMonth() + period);
  }

  // Format to YYYY-MM-DD
  const y = openDate.getFullYear();
  const m = (openDate.getMonth() + 1).toString().padStart(2, '0');
  const d = openDate.getDate().toString().padStart(2, '0');
  $('mdate').value = `${y}-${m}-${d}`;
}

// Update maturity date in Mat form based on open date and period
function updateMaturityDateMat() {
  const openDate = new Date($('open2').value);
  const period = Number($('per2').value);
  if (isNaN(openDate.getTime()) || !period) {
    $('mdate2').value = '';
    return;
  }

  if (prod === 'prarthana') {
    openDate.setFullYear(openDate.getFullYear() + period);
  } else {
    openDate.setMonth(openDate.getMonth() + period);
  }

  const y = openDate.getFullYear();
  const m = (openDate.getMonth() + 1).toString().padStart(2, '0');
  const d = openDate.getDate().toString().padStart(2, '0');
  $('mdate2').value = `${y}-${m}-${d}`;
}

// Calculate Required Deposit
function calcReq() {
  const l = curLang();
  const t = TXT[l];

  // Get inputs
  const open = $('open').value;
  const period = Number($('per').value);
  const targetStr = $('target').value;
  const rateStr = $('rate').value;

  // Validate inputs with improved checks
  if (!open) {
    alert(t.open + ' ' + 'is required');
    return;
  }
  if (!period || period <= 0) {
    alert(t.per + ' ' + 'must be positive');
    return;
  }
  const target = parseFloat(targetStr);
  if (isNaN(target) || target <= 0) {
    alert(t.target + ' ' + 'must be a positive number');
    return;
  }
  let rate = parseFloat(rateStr);
  if (isNaN(rate) || rate <= 0 || rate > 100) {
    alert(t.rateYr + ' ' + 'must be a positive number less than or equal to 100');
    return;
  }

  // Calculate compound interest
  // Formula: P = A / ( (1 + r)^n )
  // Where A = target, r = interest rate per period, n = number of periods
  // Since rate input is per year or per month, use accordingly

  let r, n;

  if (prod === 'prarthana') {
    r = rate / 100;  // yearly rate
    n = period;
  } else {
    r = rate / 100;  // monthly rate
    n = period;
  }

  // Calculate present value needed (Required deposit)
  let deposit = target / Math.pow(1 + r, n);
  deposit = Math.round(deposit * 100) / 100;

  // Format result
  let msg = '';
  if (l === 'en') {
    msg = `Required Deposit: LKR ${deposit.toLocaleString()}`;
  } else if (l === 'si') {
    msg = `‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑î‡∑Ä: ‡∂ª‡∑î. ${deposit.toLocaleString()}`;
  } else if (l === 'ta') {
    msg = `‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ: ‡Æ∞‡ØÇ. ${deposit.toLocaleString()}`;
  }

  $('res1').textContent = msg;
  saveState();
  speak(msg);
}

// Calculate Maturity Value
function calcMat() {
  const l = curLang();
  const t = TXT[l];

  const open = $('open2').value;
  const period = Number($('per2').value);
  const amtStr = $('amt').value;
  const rateStr = $('rate2').value;

  if (!open) {
    alert(t.open + ' ' + 'is required');
    return;
  }
  if (!period || period <= 0) {
    alert(t.per + ' ' + 'must be positive');
    return;
  }
  const amt = parseFloat(amtStr);
  if (isNaN(amt) || amt <= 0) {
    alert(t.install + ' ' + 'must be a positive number');
    return;
  }
  let rate = parseFloat(rateStr);
  if (isNaN(rate) || rate <= 0 || rate > 100) {
    alert(t.rateMo + ' ' + 'must be a positive number less than or equal to 100');
    return;
  }

  let r, n;

  if (prod === 'prarthana') {
    r = rate / 100; // yearly rate
    n = period;
  } else {
    r = rate / 100; // monthly rate
    n = period;
  }

  // Future Value of Annuity formula:
  // FV = P * [((1 + r)^n - 1) / r]
  let fv = amt * (Math.pow(1 + r, n) - 1) / r;
  fv = Math.round(fv * 100) / 100;

  let msg = '';
  if (l === 'en') {
    msg = `Maturity Value: LKR ${fv.toLocaleString()}`;
  } else if (l === 'si') {
    msg = `‡∂¥‡∑í‡∂ª‡∑í‡∂±‡∑ê‡∂∏‡∑ì‡∂∏‡∑ä ‡∑Ä‡∂ß‡∑í‡∂±‡∑è‡∂ö‡∂∏: ‡∂ª‡∑î. ${fv.toLocaleString()}`;
  } else if (l === 'ta') {
    msg = `‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ: ‡Æ∞‡ØÇ. ${fv.toLocaleString()}`;
  }

  $('res2').textContent = msg;
  saveState();
  speak(msg);
}

// Reset all forms and results
function resetAll() {
  $('formReq').reset();
  $('formMat').reset();
  $('res1').textContent = '';
  $('res2').textContent = '';
  updateMaturityDate();
  updateMaturityDateMat();
  saveState();
}

// Print result for given id
function printRes(id) {
  const content = $(id).textContent;
  if (!content) {
    alert('No result to print');
    return;
  }
  const newWin = window.open('', '', 'width=600,height=400');
  newWin.document.write('<pre style="font-family: Arial; font-size: 16px;">' + content + '</pre>');
  newWin.document.close();
  newWin.focus();
  newWin.print();
  newWin.close();
}

// Email result for given id
function mailRes(id) {
  const content = $(id).textContent;
  if (!content) {
    alert('No result to email');
    return;
  }
  const subject = encodeURIComponent('NSB Savings Calculator Result');
  // Encode line breaks properly
  const body = encodeURIComponent(content + '\n\nSent via NSB Savings Calculator');
  const mailto = `mailto:?subject=${subject}&body=${body}`;
  window.location.href = mailto;
}

// Text to speech output
function speak(text) {
  if (!speechEnabled) return;
  if (!window.speechSynthesis) return;

  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = curLang() === 'en' ? 'en-US' : (curLang() === 'si' ? 'si-LK' : 'ta-IN');
  window.speechSynthesis.speak(utterance);
}

// Speech toggle button
const speechToggleBtn = $('speechToggle');
speechToggleBtn.addEventListener('click', () => {
  speechEnabled = !speechEnabled;
  updateSpeechToggle();
  saveState();
});

function updateSpeechToggle() {
  if (speechEnabled) {
    speechToggleBtn.classList.add('active');
    speechToggleBtn.setAttribute('aria-pressed', 'true');
    speechToggleBtn.title = TXT[curLang()].speechOn;
    speechToggleBtn.textContent = 'üîä';
  } else {
    speechToggleBtn.classList.remove('active');
    speechToggleBtn.setAttribute('aria-pressed', 'false');
    speechToggleBtn.title = TXT[curLang()].speechOff;
    speechToggleBtn.textContent = 'üîà';
  }
}

// Check date input support
function checkDateInputSupport() {
  const input = document.createElement('input');
  input.setAttribute('type', 'date');
  const notSupported = input.type !== 'date';
  $('dateWarning').style.display = notSupported ? 'block' : 'none';
}

// Event listeners for inputs
$('open').addEventListener('change', () => {
  updateMaturityDate();
  saveState();
});
$('per').addEventListener('change', () => {
  updateMaturityDate();
  saveState();
});
$('open2').addEventListener('change', () => {
  updateMaturityDateMat();
  saveState();
});
$('per2').addEventListener('change', () => {
  updateMaturityDateMat();
  saveState();
});
$('target').addEventListener('input', saveState);
$('rate').addEventListener('input', saveState);
$('amt').addEventListener('input', saveState);
$('rate2').addEventListener('input', saveState);

// Initialize
function init() {
  setProduct(prod, false);
  applyLang();
  checkDateInputSupport();
  loadState();
  updateSpeechToggle();
}

window.addEventListener('load', init);
</script>

</body>
</html>
